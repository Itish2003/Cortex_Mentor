name: Integration Tests

on:
  pull_request:
    paths:
      - 'src/**'
      - 'tests/**'
      - 'cortex-vs/**'
      - '.github/workflows/integration-tests.yml'

jobs:
  integration-test:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv pip install -e .[dev] --system

      - name: Verify Redis connection
        run: |
          python -c "import redis; r = redis.Redis(); r.ping(); print('Redis connection successful')"

      - name: Run integration tests
        run: |
          uv run pytest tests/test_integration.py -v -m integration --tb=short
        env:
          REDIS_URL: redis://localhost:6379

      - name: Start backend server
        run: |
          uv run uvicorn src.cortex.main:app --host 0.0.0.0 --port 8000 &
          echo $! > server.pid
          sleep 5

      - name: Verify server is running
        run: |
          curl -f http://localhost:8000/ || exit 1
          echo "Server is running"

      - name: Test health endpoint
        run: |
          RESPONSE=$(curl -s http://localhost:8000/)
          echo "Response: $RESPONSE"
          echo $RESPONSE | grep -q "Cortex API is running" || exit 1

      - name: Start ARQ worker
        run: |
          uv run arq src.cortex.workers.WorkerSettings &
          echo $! > worker.pid
          sleep 5

      - name: Test WebSocket connection
        run: |
          # Install websocat for WebSocket testing
          wget -qO- https://github.com/vi/websocat/releases/download/v1.12.0/websocat.x86_64-unknown-linux-musl > websocat
          chmod +x websocat

          # Test WebSocket connection (timeout after 5 seconds)
          timeout 5 ./websocat -t ws://localhost:8000/ws || true
          echo "WebSocket connection test completed"

      - name: Cleanup
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) 2>/dev/null || true
          fi
          if [ -f worker.pid ]; then
            kill $(cat worker.pid) 2>/dev/null || true
          fi

  api-contract-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv pip install -e .[dev] --system

      - name: Run API tests
        run: |
          uv run pytest tests/test_api.py -v

      - name: Test API schema generation
        run: |
          python -c "
          from cortex.main import app
          from fastapi.openapi.utils import get_openapi
          schema = get_openapi(
              title=app.title,
              version=app.version,
              openapi_version=app.openapi_version,
              description=app.description,
              routes=app.routes,
          )
          print('OpenAPI schema generated successfully')
          print(f'Endpoints: {len([r for r in app.routes if hasattr(r, \"methods\")])}')
          "

  pipeline-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv pip install -e .[dev] --system

      - name: Run pipeline tests
        run: |
          uv run pytest tests/test_pipelines.py tests/test_comprehension.py tests/test_curation.py tests/test_delivery.py tests/test_graph_traversal.py -v

      - name: Run worker tests
        run: |
          uv run pytest tests/test_workers.py -v
